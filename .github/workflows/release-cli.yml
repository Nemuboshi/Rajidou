name: Release CLI

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  verify:
    name: Verify
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "stable"
          check-latest: true
          cache: true
          cache-dependency-path: go.sum

      - name: Run tests
        run: go test ./...

  release:
    name: Build ${{ matrix.goos }}-${{ matrix.arch_label }}
    needs: verify
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            pkg_target: linux
            arch_label: x64
            bin_ext: ""
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
            pkg_target: linux
            arch_label: arm64
            bin_ext: ""
          - os: macos-latest
            goos: darwin
            goarch: amd64
            pkg_target: macos
            arch_label: x64
            bin_ext: ""
          - os: macos-latest
            goos: darwin
            goarch: arm64
            pkg_target: macos
            arch_label: arm64
            bin_ext: ""
          - os: windows-latest
            goos: windows
            goarch: amd64
            pkg_target: win
            arch_label: x64
            bin_ext: ".exe"
          - os: windows-latest
            goos: windows
            goarch: arm64
            pkg_target: win
            arch_label: arm64
            bin_ext: ".exe"

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "stable"
          check-latest: true
          cache: true
          cache-dependency-path: go.sum

      - name: Build CLI
        shell: bash
        run: |
          mkdir -p release
          OUTPUT="release/rajidou-${GITHUB_REF_NAME}-${{ matrix.pkg_target }}-${{ matrix.arch_label }}${{ matrix.bin_ext }}"
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} CGO_ENABLED=0 \
            go build -trimpath -buildvcs=false -ldflags "-s -w -buildid=" -o "${OUTPUT}" ./cmd/rajidou

      - name: Install UPX
        shell: bash
        run: |
          if command -v upx >/dev/null 2>&1; then
            upx --version
            exit 0
          fi

          case "${{ runner.os }}" in
            Linux)
              sudo apt-get update
              sudo apt-get install -y upx-ucl || sudo apt-get install -y upx
              ;;
            macOS)
              brew install upx
              ;;
            Windows)
              choco install upx -y
              ;;
          esac

      - name: Compress with UPX
        shell: bash
        run: |
          OUTPUT="release/rajidou-${GITHUB_REF_NAME}-${{ matrix.pkg_target }}-${{ matrix.arch_label }}${{ matrix.bin_ext }}"
          CANDIDATE="${OUTPUT}.upx"
          cp "${OUTPUT}" "${CANDIDATE}"
          if upx --best --lzma "${CANDIDATE}"; then
            mv "${CANDIDATE}" "${OUTPUT}"
            echo "UPX compression succeeded; keeping compressed binary only."
          else
            rm -f "${CANDIDATE}"
            echo "UPX compression failed; keeping original binary."
          fi

      - name: Upload CI artifact
        uses: actions/upload-artifact@v6
        with:
          name: rajidou-${{ github.ref_name }}-${{ matrix.pkg_target }}-${{ matrix.arch_label }}
          path: release/*
          if-no-files-found: error

      - name: Publish to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
